var Main = Poyo.scene("Main",(Po)=>{
  var sche = Schedule();
  loadData();
  var scene = {};
  var btn = Shape.rect(100,100).with(Po.button((mx,my)=>{
    console.log(mx,my);
    Po.transit("Sub");
  }));
  btn.translate(100,100);
  var p = Po.ease({x:0,y:0}).inf(0.125);
  scene.step = ()=>{
    p.to(Po.mouse);
  };
  scene.draw = (R)=>{
    R.rotated(Po.time*Math.PI/180,()=>{
      Shape.image("test").with(R.draw);
    });
    Shape.text("ぽよ").center.with(R.translate(Po.size.x/2,Po.size.y/2).scale(600,600).fill(Color.grey.alpha(0.2)).draw);
    Shape.line(Po.size.x,0,0,Po.size.y).with(R.stroke(10,Color.brown.alpha(0.5)).draw);
    btn.with([
      R.fill(Color.orange).shadow(btn.hover*5+5).draw,
      R.stroke(2,Color.red).draw
    ]);
    Shape.circle(5).translate(p().x,p().y).with(R.fill(Color.blue).shadow(5).draw);
    R.translated(Po.size.x-p().x,Po.size.y-p().y,()=>{
      Shape.circle(5).with(R.fill(Color.cyan).shadow(5).draw);
    });
    R.translated(Po.size.x/2,Po.size.y/2,()=>{
      Shape.rect(50,50).with(Shape.translate(-25,-25)).with([
        R.fill(Color.yellow).shadow(5).draw,
        R.scale(0.5,0.5).fill(Color.black).draw
      ]);
    });
    Shape.roundrect(100,100,30).translate(Po.size.x*0.7,Po.size.y*0.7).with([
      (s)=>{
        s.onCollide(Po.mouse.x,Po.mouse.y,()=>{
          s.with(R.fill(Color.magenta).draw);
        });
      },
      R.stroke(2,Color.purple).draw
    ]);
  };
  return scene;
});

var Sub = Poyo.scene("Sub",(Po)=>{
  var scene = {};
  var slide = Po.ease(0).cubic.inOut(40);
  var bar = Po.ease(0).cubic.in(40);
  bar.set(1);
  scene.spawn = (t,kill)=>{
    if(bar.done)kill();
  };
  var back = Shape.circle(150).with(Po.button((mx,my)=>{
    console.log(mx,my);
    Po.transit("Main");
  }));
  back.translate(Po.size.x,0);
  var bScale = Po.ease(1).cubic.out(20);
  var dialog = Shape.rect(100,100).with(Po.button(()=>{
    Po.dialog(["そばや","帰ってほしい"],["は？","わかる"],(i,close)=>{
      if(i==-1)close();
      else{
        console.log(i==0?"#それはそう":"わかりみを得た");
      }
    });
  }));
  dialog.translate(Po.size.x/4,Po.size.y/2);
  var drag = Shape.circle(40).with(Po.drag(Po.size.x/4+40,Po.size.y/8+40,Po.size.x/2-80,Po.size.y/4-80));
  drag.translate(Po.size.x/2,Po.size.y/4);
  scene.step = ()=>{
    back.onCollide(Po.mouse.x,Po.mouse.y,(x,y)=>{
      if(!back.landed){
        back.with(Shape.scale(1.2,1.2));
        bScale.force(1/1.2);
        bScale.set(1);
        back.landed=true;
      }
    },(x,y)=>{
      if(back.landed){
        back.with(Shape.scale(1/1.2,1/1.2));
        bScale.force(1.2);
        bScale.set(1);
        back.landed=false;
      }
    });
  };
  scene.draw = (R,befScene)=>{
    R.translated(0,slide()*Po.size.y,()=>{
      R.translated(0,-Po.size.y,()=>{
        befScene();
      });
      R.translated(0,bar()*Po.size.y-Po.size.y,()=>{
        Shape.rect(Po.size.x,Po.size.y).with(R.fill(Color.white).draw);
      });
      R.clipped(0,0,Po.size.x,bar()*Po.size.y,()=>{
        Shape.rect(Po.size.x/2,Po.size.y/4).invert().with(Shape.translate(Po.size.x/4,Po.size.y/8)).with([
          R.fill(Color.white).shadow(10).draw,
          R.stroke(2,Color.black).draw
        ]);
        Shape.circle(40).translate(Po.mouse.x,Po.mouse.y).with(R.fill(Color.green.alpha(0.5)).draw);
        R.transformed(back,()=>{
          R.scaled(bScale(),bScale(),()=>{
            back.with([
              R.scale(1.00,1.00).fill(Color.blue).shadow(5).draw,
              R.scale(0.95,0.95).fill(Color.make(0,0.5,1)).shadow(5).draw,
              R.scale(0.90,0.90).fill(Color.cyan).shadow(5).draw
            ]);
          });
        });
        dialog.with([
          R.fill(Color.white).shadow(dialog.hover*5+10).draw,
          R.stroke(3,Color.black).shadow(2).draw
        ]);
        R.lightened(drag.light>0.5?1.0/4.0:0,()=>{
          drag.with([
            R.fill(Color.yellow).shadow(5).draw,
            R.stroke(2,Color.orange).draw
          ]);
          R.transformed(drag,()=>{
            Shape.text("ぽ").center.rotate(-Po.time*Math.PI/180).scale(60,60).with(R.fill(Color.brown).draw);
          });
        });
      });
      if(bar()!=1)Shape.rect(Po.size.x,5).translate(0,bar()*Po.size.y).with(R.fill(Color.black).shadow(5).draw);
    });
  };
  scene.end = (t,kill)=>{
    if(t==0)slide.set(1);
    if(slide.done)kill();
  };
  return scene;
});
